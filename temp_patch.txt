      debugPrint('≡ƒîÄ No user profile - using defaults (US, en)');
    }

    debugPrint('≡ƒÜÇ Sending image to detector+search endpoint: $endpoint');
    final response = await _client.post(
      Uri.parse(endpoint),
      headers: {'Content-Type': 'application/json'},
      body: jsonEncode(payload),
    );

    if (response.statusCode != 200) {
      throw Exception(
        'Detector server responded with ${response.statusCode}: ${response.body}',
      );
    }

    final data = jsonDecode(response.body) as Map<String, dynamic>;
    _lastResponseFromCache = data['cached'] == true;
    if (data['success'] != true) {
      final message = (data['message'] as String?) ?? 'Unknown detector error';
      throw Exception('Detector pipeline failed: $message');
    }

    final resultsRaw = (data['results'] as List<dynamic>? ?? const [])
        .map((e) => (e as Map<String, dynamic>))
        .toList();

    if (resultsRaw.isEmpty) {
      return const <DetectionResult>[];
    }
